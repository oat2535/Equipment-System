{% extends 'base.html' %}
{% load static %}

{% block title %}Equipment List - Asset Management System{% endblock %}

{% block extra_css %}
<link href="{% static 'vendor/datatables/dataTables.bootstrap4.min.css' %}" rel="stylesheet">
<style>
    @media print {
        body * {
            visibility: hidden;
        }
        #printableArea, #printableArea * {
            visibility: visible;
        }
        #printableArea {
            position: absolute;
            left: 50%;
            top: 100px;
            transform: translateX(-50%);
            width: auto;
            text-align: center;
        }
        .modal-backdrop {
            display: none !important;
        }
    }
    .btn-purple {
        color: #fff;
        background-color: #6f42c1;
        border-color: #6f42c1;
    }
    .btn-purple:hover {
        color: #fff;
        background-color: #59359a;
        border-color: #52308f;
    }
    .btn-purple.disabled, .btn-purple:disabled {
        color: #fff;
        background-color: #6f42c1;
        border-color: #6f42c1;
        opacity: 0.65;
    }
    .badge-purple {
        color: #fff;
        background-color: #6f42c1;
    }
    .btn-amber {
        color: #fff;
        background-color: #ffc107;
        border-color: #ffc107;
    }
    .btn-amber:hover {
        color: #fff;
        background-color: #e0a800;
        border-color: #d39e00;
    }
    .btn-amber.disabled, .btn-amber:disabled {
        color: #fff;
        background-color: #ffc107;
        border-color: #ffc107;
        opacity: 0.65;
    }
    .badge-amber {
        color: #fff;
        background-color: #ffc107;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Equipment List</h1>
    {% if user.is_staff %}
    <a href="{% url 'add_equipment' %}" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
        <i class="fas fa-plus fa-sm text-white-50"></i> Add Equipment
    </a>
    {% endif %}
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">All Equipment</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
                <thead class="thead-light">
                    <tr>
                        <th style="width: 20%;">Name</th>
                        <th style="width: 10%;">Serial No.</th>
                        <th style="width: 10%;" class="text-center">Status</th>
                        <th style="width: 5%;" class="text-center">Total</th>
                        <th style="width: 5%;" class="text-center">Avail.</th>
                        <th style="width: 8%;" class="text-center">Image</th>
                        <th style="width: 15%;">Description</th>
                        <th style="width: 10%;">Category</th>
                        <th style="width: 5%;" class="text-center">QR</th>
                        <th style="width: 12%;" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for equipment in equipment_list %}
                    <tr>
                        <td class="align-middle">{{ equipment.name }}</td>
                        <td class="align-middle">{{ equipment.serial_number|default:"-" }}</td>
                        <td class="text-center align-middle">
                            {% if equipment.available_quantity == 0 %}
                                <span class="badge badge-secondary">Not Available</span>
                            {% elif equipment.status == 'AVAILABLE' %}
                                <span class="badge badge-success">{{ equipment.get_status_display }}</span>
                            {% elif equipment.status == 'MAINTENANCE' %}
                                <span class="badge badge-amber">{{ equipment.get_status_display }}</span>
                            {% elif equipment.status == 'LOST' %}
                                <span class="badge badge-purple">{{ equipment.get_status_display }}</span>
                            {% elif equipment.status == 'DAMAGED' %}
                                <span class="badge badge-danger">{{ equipment.get_status_display }}</span>
                            {% else %}
                                <span class="badge badge-secondary">{{ equipment.get_status_display }}</span>
                            {% endif %}
                        </td>
                        <td class="text-center align-middle">{{ equipment.total_quantity }}</td>
                        <td class="text-center align-middle">{{ equipment.available_quantity }}</td>
                        <td class="text-center align-middle">
                            {% if equipment.image %}
                                <button type="button" class="btn btn-info btn-sm view-image-btn" data-image-url="{{ equipment.image.url }}" data-image-name="{{ equipment.name }}">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            {% else %}
                                <span class="text-muted small">No Image</span>
                            {% endif %}
                        </td>
                        <td class="align-middle">{{ equipment.description|truncatechars:30 }}</td>
                        <td class="align-middle">{{ equipment.category.name }}</td>
                        <td class="text-center align-middle">
                            {% if user.is_staff %}
                            <button class="btn btn-light btn-sm qr-btn border" data-id="{{ equipment.id }}" data-name="{{ equipment.name }}">
                                <i class="fas fa-qrcode text-dark"></i>
                            </button>
                            {% endif %}
                        </td>
                        <td class="text-center align-middle">
                            <div class="d-flex justify-content-center">
                                {% if equipment.available_quantity == 0 %}
                                    <button class="btn btn-secondary btn-sm disabled mr-1" disabled title="Not Available">
                                        <i class="fas fa-minus-circle"></i>
                                    </button>
                                {% elif equipment.status == 'AVAILABLE' %}
                                    <a href="{% url 'equipment_request' equipment.id %}" class="btn btn-primary btn-sm mr-1" title="Request">
                                        <i class="fas fa-hand-holding"></i>
                                    </a>
                                {% elif equipment.status == 'MAINTENANCE' %}
                                    <button class="btn btn-secondary btn-sm disabled mr-1" disabled title="Maintenance">
                                        <i class="fas fa-tools"></i>
                                    </button>
                                {% elif equipment.status == 'DAMAGED' %}
                                    <button class="btn btn-secondary btn-sm disabled mr-1" disabled title="Damage">
                                        <i class="fas fa-times-circle"></i>
                                    </button>
                                {% elif equipment.status == 'LOST' %}
                                    <button class="btn btn-secondary btn-sm disabled mr-1" disabled title="Lost">
                                        <i class="fas fa-search-minus"></i>
                                    </button>
                                {% else %}
                                     <button class="btn btn-secondary btn-sm disabled mr-1" disabled>{{ equipment.get_status_display }}</button>
                                {% endif %}
                                
                                {% if user.is_staff %}
                                <a href="{% url 'edit_equipment' equipment.id %}" class="btn btn-warning btn-sm mr-1" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-danger btn-sm delete-equipment-btn" data-equipment-id="{{ equipment.id }}" data-equipment-name="{{ equipment.name }}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Equipment Image</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="Equipment Image">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteEquipmentModal" tabindex="-1" role="dialog" aria-labelledby="deleteEquipmentModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteEquipmentModalLabel">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete <strong id="deleteEquipmentName"></strong>? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <form id="deleteEquipmentForm" method="post" action="">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" role="dialog" aria-labelledby="qrModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrModalLabel">QR Code</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <div id="printableArea">
                    <div id="qrcode" class="d-flex justify-content-center"></div>
                    <h4 class="mt-3 text-dark font-weight-bold" id="qrText"></h4>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="window.print()">Print</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'vendor/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'vendor/datatables/dataTables.bootstrap4.min.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    $(document).ready(function() {
        $('#dataTable').DataTable({
            "order": []
        });

        // Handle View Image click
        $('#dataTable').on('click', '.view-image-btn', function() {
            var imageUrl = $(this).data('image-url');
            var imageName = $(this).data('image-name');
            $('#modalImage').attr('src', imageUrl);
            $('#imageModalLabel').text(imageName);
            $('#imageModal').modal('show');
        });

        // Handle QR Code click
        $('#dataTable').on('click', '.qr-btn', function() {
            var equipmentId = $(this).data('id');
            var equipmentName = $(this).data('name');
            var url = window.location.origin + "/request/" + equipmentId + "/"; // Link to request page
            
            $('#qrModalLabel').text("QR Code for " + equipmentName);
            $('#qrText').text(equipmentName);
            $('#qrcode').empty(); // Clear previous QR
            
            new QRCode(document.getElementById("qrcode"), {
                text: url,
                width: 256,
                height: 256
            });
            
            $('#qrModal').modal('show');
        });

        // Handle Delete Equipment click
        $('#dataTable').on('click', '.delete-equipment-btn', function() {
            var equipmentId = $(this).data('equipment-id');
            var equipmentName = $(this).data('equipment-name');
            var deleteUrl = "{% url 'delete_equipment' 0 %}".replace('0', equipmentId);
            
            $('#deleteEquipmentName').text(equipmentName);
            $('#deleteEquipmentForm').attr('action', deleteUrl);
            $('#deleteEquipmentModal').modal('show');
        });
    });
</script>
{% endblock %}
